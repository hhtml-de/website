import { parseHTML } from 'linkedom';
import htmlmin from 'html-minifier-terser';

const isProduction = process.env.ELEVENTY_ENV === 'production';

import transforms from './transforms/index.js';

const minify = (content) => htmlmin.minify(content, {
  collapseBooleanAttributes: true,
  collapseWhitespace: true,
  decodeEntities: true,
  includeAutoGeneratedTags: false,
  removeComments: true,
});

export default (eleventyConfig) => {
  eleventyConfig.addTransform('html-minify', async (content, path) => {
    if (path && path.endsWith('.html')) {
      const window = parseHTML(content);

      for (const transform of transforms) {
        const postprocess = await transform(window, content, path);
        content = window.document.toString();
        if (typeof postprocess === "function") {
          content = await postprocess(content);
        }
      }

      return isProduction ? minify(content) : content;
    }

    return content;
  });
};
